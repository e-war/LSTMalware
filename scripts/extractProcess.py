import csv, re, os


inpath = '/mnt/1tb/unishare/prefilter/'
outpath = '/mnt/1tb/unishare/filtered/'

for file in os.listdir(inpath):
    fullpath = inpath+file
    fulloutpath = outpath+file
    with open(inpath+file,'r') as file:
        infile = file.readlines()
    file.close()

    print("READING:",len(infile),"Lines...")
    WATCHED_PID = []
    WATCHED_TID = []
    total_log = []
    csvIN = csv.DictReader(infile)
    next(csvIN,None)
    for line in csvIN:
        if(line['Process Name'] == 'powershell.exe' or line['TID'] in WATCHED_TID or line['PID'] in WATCHED_PID):
            if(line['Operation'] == 'Process Create'):
                WATCHED_PID.append(re.search(r'PID: (\d{1,7}),',line['Detail']).group(1))
                print("tracking: ",line['Process Name'])
            if(line['Operation'] == 'Thread Create'):
                WATCHED_TID.append(line['Detail'].replace('Thread ID: ',''))
            if(line['Operation'] != 'Process Profiling' and line['Process Name'] != 'powershell.exe'):total_log.append(line)
    if(len(total_log)< 40000 or len(total_log) > 300000): continue
    headers = ['\ufeff"Time of Day"','Process Name','Operation','Path','Result','Detail','Duration','Image Path','TID','PID']

    with open (fulloutpath,'w') as outfile:
        outfile.write("Time of Day,Process Name,Operation,Path,Result,Detail,Duration,Image Path,TID,PID" + '\n')
        csvOUT = csv.DictWriter(outfile,fieldnames=headers)
        for x in total_log:
            csvOUT.writerow(x)
    outfile.close()
    print("FINISHED:",len(total_log),"Lines...")